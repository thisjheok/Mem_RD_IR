cmake_minimum_required(VERSION 3.20)
project(ReusePass LANGUAGES C CXX)

# LLVM ì°¾ê¸° (configure ì‹œ: cmake -DLLVM_DIR=$(llvm-config --cmakedir) ..)
find_package(LLVM REQUIRED CONFIG)
message(STATUS "Found LLVM ${LLVM_PACKAGE_VERSION}")
message(STATUS "LLVM_DIR: ${LLVM_DIR}")

set(CMAKE_CXX_STANDARD 17)
set(CMAKE_CXX_STANDARD_REQUIRED ON)

# âš ï¸ ìˆ¨ê¹€ í”Œë˜ê·¸ê°€ ì„ì¼ ìˆ˜ ìˆìœ¼ë‹ˆ LLVM_DEFINITIONSëŠ” ë„£ì§€ ì•ŠìŠµë‹ˆë‹¤.
include_directories(${LLVM_INCLUDE_DIRS})

# SHARED ê¶Œì¥ (MODULEì¼ ë•Œ dead-strip ì´ìŠˆ í”¼í•˜ê¸°)
add_library(ReusePass SHARED ReusePass.cpp)

# ê°€ì‹œì„±: ê¸°ë³¸(default)ë¡œ ê°•ì œ
set_target_properties(ReusePass PROPERTIES
  CXX_VISIBILITY_PRESET default
  VISIBILITY_INLINES_HIDDEN NO
  MACOSX_RPATH ON
)

# ğŸ”’ ì‹¬ë³¼ í™•ì‹¤íˆ ë‚´ë³´ë‚´ê¸° (macOS: ì–¸ë”ìŠ¤ì½”ì–´ í¬í•¨)
#  - exportëœ ì‹¬ë³¼ì´ ìˆì–´ì•¼ optê°€ í”ŒëŸ¬ê·¸ì¸ìœ¼ë¡œ ì¸ì‹
set_target_properties(ReusePass PROPERTIES
  LINK_FLAGS "-Wl,-exported_symbol,_llvmGetPassPluginInfo"
)

# ë§í¬ ë¼ì´ë¸ŒëŸ¬ë¦¬
llvm_map_components_to_libnames(REQ_LLVM_LIBS
  Core IRReader Support Analysis TransformUtils
)
target_link_libraries(ReusePass PRIVATE ${REQ_LLVM_LIBS})

# (ëŒ€ì•ˆ) í™˜ê²½ ë”°ë¼ ìœ„ ì»´í¬ë„ŒíŠ¸ ë§¤í•‘ì´ ì•ˆ ë¨¹íˆë©´ ì•„ë˜ ì§ì ‘ ì´ë¦„ ì‚¬ìš©
# target_link_libraries(ReusePass PRIVATE
#   LLVMCore LLVMIRReader LLVMSupport LLVMAnalysis LLVMTransformUtils
# )
